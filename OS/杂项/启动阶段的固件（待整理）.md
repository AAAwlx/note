# 启动

bios —> bootloader -> os

是的，BIOS（Basic Input/Output System）通常被固化在主板上的ROM芯片中，但现代系统已逐步转向更灵活的存储方案（如UEFI固件存储在闪存中）。以下是详细解析：

1. 传统BIOS的存储介质

(1) ROM（Read-Only Memory）

• 早期BIOS：  

  存储在掩膜ROM（Mask ROM）或PROM（Programmable ROM）中，出厂后无法修改。
  • 特点：  

    ◦ 数据永久性写入，不可更新。  

    ◦ 安全性高（无法被病毒篡改），但功能无法升级。

(2) EEPROM/Flash ROM

• 现代BIOS：  

  改用EEPROM（电可擦写ROM）或NOR Flash芯片存储，支持固件更新。
  • 特点：  

    ◦ 可通过主板厂商工具或操作系统更新（如fwupd）。  

    ◦ 典型芯片：SPI Flash（Serial Peripheral Interface Flash），容量通常为16MB~32MB。  

    ◦ 示例：  
      # Linux下查看BIOS芯片信息（需root权限）
      dmidecode -t bios
      

2. 现代UEFI固件的存储

• UEFI（Unified Extensible Firmware Interface）：  

  取代传统BIOS，但仍沿用“BIOS”的通俗称呼。
  • 存储位置：  

    ◦ 仍位于主板的SPI Flash芯片中，但分区更复杂（包含多个EFI分区）。  

    ◦ 支持从硬盘的EFI系统分区（ESP）加载扩展驱动和引导程序。  

  • 更新方式：  

    ◦ 通过厂商提供的固件包（如.CAP文件）刷写。  

    ◦ 操作系统内直接更新（如Windows Update推送的固件升级）。

3. 为什么使用ROM/Flash？

• 可靠性：  

  断电后数据不丢失，确保开机时始终可读取。  
• 独立性：  

  不依赖硬盘或操作系统，故障时仍能提供基础硬件检测（POST）。  
• 安全性：  

  物理隔离（如Intel的Boot Guard技术防止固件被篡改）。

4. 物理位置与芯片识别

• 主板上的BIOS芯片：  

  • 通常为8引脚或16引脚的方形芯片，标注有厂商（如Winbond、Macronix）和型号（如MX25L12873F）。  

  • 旁边可能有CMOS电池（用于保存用户设置，与BIOS存储无关）。  

• 损坏表现：  

  • 开机黑屏、无法进入BIOS设置界面。  

  • 需编程器重新烧录固件（如CH341A工具）。

5. 与CMOS的区别

特性 BIOS/UEFI固件 CMOS

存储内容 硬件初始化代码和设置界面 用户配置（如时间、启动顺序）

存储介质 ROM/Flash 易失性RAM（依赖主板电池供电）

更新方式 刷写固件 修改BIOS设置或重置电池

6. 未来趋势

• 替代方案：  

  • 部分服务器使用BMC（基板管理控制器）远程管理固件。  

  • 微软的Pluton安全芯片可能集成固件功能。  

• 挑战：  

  • 闪存芯片寿命有限（约1000~10000次擦写），需谨慎更新。

总结

• 传统BIOS：固化在不可擦写的ROM中（早期）或可更新的Flash芯片（现代）。  

• UEFI固件：存储在SPI Flash，支持灵活升级和扩展功能。  

• 用户操作：  

  • 更新BIOS需遵循厂商指南，错误操作可能导致主板变砖。  

  • 重置CMOS可恢复默认设置，但不会影响固件本身。


如何理解“支持从硬盘的EFI系统分区（ESP）加载扩展驱动或引导”？

这句话描述了 UEFI 固件 的一个重要特性：它不仅依赖主板上的 SPI Flash 芯片（存储核心 UEFI 固件），还能从硬盘的 EFI 系统分区（ESP, EFI System Partition） 动态加载额外的驱动或引导程序。以下是详细解析：

1. EFI 系统分区（ESP）的作用

• 存储位置：  

  硬盘（SSD/HDD）上的一个独立分区（通常格式化为 FAT32）。  
• 核心功能：  

  • 存放 操作系统的引导加载程序（如 grubx64.efi、bootmgfw.efi）。  

  • 存放 UEFI 驱动（如显卡固件、网络启动模块）。  

  • 存放 硬件厂商提供的扩展固件（如 NVMe SSD 的 UEFI 驱动）。  

2. 具体加载流程

步骤 1：主板 SPI Flash 中的 UEFI 固件初始化

• 开机时，CPU 首先执行主板 SPI Flash 芯片 中的 UEFI 固件。  

• UEFI 完成硬件检测（POST），并初始化基本设备（如内存、PCIe 控制器）。

步骤 2：加载硬盘 ESP 分区的内容

• UEFI 会扫描所有存储设备的 GPT 分区表，寻找 EFI 系统分区（标识为 EF00 类型）。  

• 从 ESP 分区中读取：

  • 引导管理器（如 \EFI\Microsoft\Boot\bootmgfw.efi 启动 Windows）。  

  • 驱动程序（如 \EFI\drivers\nvmex64.efi 用于 NVMe SSD 支持）。  

步骤 3：执行引导或加载驱动

• 引导操作系统：  

  UEFI 直接运行 ESP 中的 .efi 文件（如 grubx64.efi），进而加载内核（如 vmlinuz 或 ntoskrnl.exe）。  
• 加载扩展驱动：  

  如果硬件需要额外驱动（如某些 RAID 卡或特殊存储设备），UEFI 会从 ESP 加载对应的 .efi 驱动文件。

3. 实际应用场景

(1) 多系统引导（Windows + Linux）

• ESP 分区 中可能包含：

  • \EFI\Microsoft\Boot\bootmgfw.efi（Windows 引导）。  

  • \EFI\ubuntu\grubx64.efi（Linux 的 GRUB 引导）。  

• UEFI 通过 启动菜单（Boot Menu） 选择执行哪个 .efi 文件。

(2) 特殊硬件支持

• 某些设备（如企业级 NVMe SSD）可能需要 UEFI 阶段加载驱动才能被识别。  

• 厂商会提供 .efi 驱动文件，需手动放入 ESP 分区的 \EFI\drivers\ 目录。

(3) 网络启动（PXE）

• UEFI 可从 ESP 加载 网络驱动（如 snponly.efi），实现无盘启动。

4. 如何查看和管理 ESP 分区？

(1) Linux 系统

# 查看所有分区（ESP 通常为 FAT32 格式）
lsblk -f

# 挂载 ESP 分区（假设为 /dev/nvme0n1p1）
sudo mount /dev/nvme0n1p1 /mnt
ls /mnt/EFI  # 查看引导文件


(2) Windows 系统

• 使用 DiskPart 工具：
  diskpart
  list volume          # 找到 ESP 分区（通常为 FAT32，隐藏）
  assign letter=S:     # 临时分配盘符
  
• 文件路径：S:\EFI\Microsoft\Boot\

(3) macOS 系统

• ESP 分区默认挂载在 /Volumes/EFI（需手动挂载）：
  sudo diskutil mount /dev/disk0s1
  

5. 与传统 BIOS 引导的区别

特性 UEFI + ESP 分区 传统 BIOS + MBR

引导文件位置 硬盘的 ESP 分区（FAT32） 硬盘的 MBR 扇区 + 活动分区

驱动加载 支持从 ESP 加载 .efi 驱动 无此功能，依赖内核内置驱动

多系统支持 每个系统有独立的 .efi 文件 依赖 boot.ini 或 GRUB 链式加载

安全性 支持 Secure Boot（验证 .efi 签名） 无签名验证，易被恶意代码篡改

6. 常见问题

Q1: 如果删除 ESP 分区会怎样？

• 系统无法启动（UEFI 找不到引导文件），需通过安装介质修复。

Q2: 能否将 ESP 分区放在 USB 盘？

• 可以，但需主板支持从 USB 设备的 ESP 分区启动（部分固件可能限制此功能）。

Q3: 为什么 ESP 必须是 FAT32？

• UEFI 规范强制要求，因 FAT32 兼容性最好，且支持固件直接读写。

总结

• “从硬盘的 EFI 分区加载扩展驱动或引导” 是指 UEFI 不仅依赖主板固件，还能动态加载硬盘上的引导程序和驱动，从而实现更灵活、安全的启动流程。  

• ESP 分区 是 UEFI 时代的核心设计，也是多系统共存和硬件兼容性的关键。

你的理解部分正确，但需要更精确的区分。以下是 传统BIOS（i386时代） 和 现代UEFI 在存储位置和运行机制上的详细对比：

1. 传统BIOS（i386架构）

(1) BIOS的存储位置

• 物理存储：  

  BIOS固件固化在主板的ROM芯片中（早期是掩膜ROM，后期为可刷写的Flash ROM）。  
  • ROM区域：主板上的物理芯片（如DIP封装或SPI Flash），与内存无关。  

  • 示例芯片：Winbond W25Q128（16MB SPI Flash）。

(2) BIOS的运行过程

1. 开机上电：  
   CPU从固定地址（0xFFFF0，位于主板ROM的地址空间）开始执行BIOS代码。  
2. 映射到内存：  
   • BIOS代码被映射到内存的高地址区域（如0xF0000-0xFFFFF），但实际仍在ROM中。  

   • 此时内存（DRAM）尚未初始化，CPU直接通过总线访问ROM。  

3. POST（硬件自检）：  
   BIOS初始化硬件（内存、显卡等），最后从磁盘的MBR（主引导记录）加载引导程序。

(3) 关键点

• BIOS不在内存中存储：  

  运行时通过总线直接读取ROM，仅将部分代码映射到内存地址空间（非DRAM物理存储）。  
• 与磁盘无关：  

  BIOS完全独立于硬盘，即使没有硬盘也能运行（但无法启动操作系统）。

2. 现代UEFI

(1) UEFI固件的存储位置

• 物理存储：  

  UEFI核心固件仍存储在主板的SPI Flash芯片中（类似传统BIOS的升级版）。  
  • 芯片示例：Macronix MX25L25635F（32MB SPI Flash）。  

• ESP分区的作用：  

  • 非固件存储：ESP分区（位于磁盘）仅存放引导加载程序（如bootx64.efi）和扩展驱动。  

  • 固件本身仍在ROM中：UEFI的核心代码不依赖磁盘，即使移除硬盘也能进入设置界面。

(2) UEFI的运行过程

1. 开机执行SPI Flash中的UEFI：  
   CPU从主板ROM加载并运行UEFI核心代码（与BIOS类似）。  
2. 加载ESP分区内容：  
   • UEFI初始化硬件后，扫描磁盘的GPT分区表，找到ESP分区（FAT32格式）。  

   • 从ESP加载操作系统的引导程序（如Windows的bootmgfw.efi）或驱动（如NVMe的NvmExpressDxe.efi）。  

3. 启动操作系统：  
   由ESP中的.efi文件继续加载内核（如Linux的vmlinuz或Windows的ntoskrnl.exe）。

(3) 关键点

• UEFI固件仍在ROM中：  

  核心固件始终位于主板SPI Flash，ESP分区仅用于扩展功能。  
• ESP分区是“扩展”而非“主体”：  

  类似于传统BIOS从磁盘MBR加载引导程序，但UEFI的扩展性更强（支持多引导、驱动模块化）。

3. 对比总结

特性 传统BIOS（i386） 现代UEFI

固件存储位置 主板ROM芯片（映射到内存地址空间） 主板SPI Flash芯片

是否依赖磁盘 否（但需磁盘MBR启动OS） 否（但需磁盘ESP分区加载引导程序/驱动）

运行时内存占用 部分代码映射到内存地址空间（非DRAM） 类似，核心代码仍在ROM中

扩展性 仅支持MBR和简单引导 支持ESP分区、模块化驱动、Secure Boot

4. 常见误解澄清

• 误解1：“UEFI在磁盘ESP分区中”  

  • 纠正：UEFI核心仍在主板ROM中，ESP分区仅存储辅助文件（如引导程序）。  

• 误解2：“BIOS运行时复制到内存”  

  • 纠正：BIOS代码始终在ROM中，仅通过内存地址空间访问（非DRAM存储）。  

5. 实际场景验证

(1) 查看UEFI固件存储（Linux）

# 查看SPI Flash芯片信息（需硬件支持）
sudo dmidecode -t bios

输出示例：

BIOS Information
    Vendor: American Megatrends
    Version: 5.12
    Release Date: 01/01/2023
    Address: 0xF0000        # 映射到内存地址空间
    Runtime Size: 64 kB     # 运行时占用的地址空间大小
    ROM Size: 16 MB         # 实际SPI Flash芯片容量


(2) 查看ESP分区内容

# 挂载ESP分区（假设为/dev/nvme0n1p1）
sudo mount /dev/nvme0n1p1 /mnt
ls /mnt/EFI

输出示例：

EFI/
├── BOOT/
│   └── BOOTX64.EFI     # 默认引导程序
└── Ubuntu/
    └── grubx64.efi     # Linux引导文件


总结

• i386 BIOS：固件位于主板ROM，运行时通过内存地址空间访问，与磁盘无关。  

• 现代UEFI：固件仍位于主板SPI Flash，但利用磁盘的ESP分区加载引导程序和驱动（扩展功能）。  

• 核心原则：  

  无论是BIOS还是UEFI，其核心固件始终在主板的非易失性存储器（ROM/Flash）中，磁盘上的内容仅用于辅助启动。