# 关于文件和mmap映射两者大小不同时写入情况

在面试时可能会被问到类似以下的问题：

1. 有一个大小为1k的大小的文件，使用mmap映射到2k的内存，向1k~2k之间写入会发生什么？
2. 如果用mmap映射了2k, 向2k之后写入会如何？

这里在写入的过程中会有以下几种状态

1. 引发段错误导致程序崩溃
2. 写入到pagecache
3. 写入到磁盘中

这里首先要考虑文件的物理大小是多大。

文件的物理大小（du 命令显示的磁盘占用）与逻辑大小（ls -l 显示的文件大小）不同。文件的物理大小是指实际占用的磁盘大小，而文件的逻辑大小在则是记录在 inode 中的 size 大小。

如果超过文件的物理大小则一定会引发段错误。

那对于写入偏移量小于文件物理大小的情况会怎样？

这里又可以分为：

1. 写入的偏移量大于 mmap 映射的大小
2. 写入的偏移介于 mmap 映射大小和文件逻辑大小之间，mmap 映射大小 > 写入的偏移 > 文件逻辑大小

mmap 的映射中存在一个对齐数的问题，因为在mmap中对于未命中的虚拟内存是直接向伙伴系统申请，因此分配出的都是整页的内存。所以会有一个 4k 倍的对齐数。以上面的问题为例，如果 2k < 写入偏移量 < 4k 此时也可以成功，但是如果大于 4k 就会段错误。

对于情况2，此时写入并不会发生段错误，但是在对数据进行回写时，大于文件逻辑大小的这一部分内容并不会被写入到磁盘当中。这是文件系统回写的规则

（1）fsync 的行为

fsync(fd) ​仅确保文件当前逻辑大小范围内的数据落盘​（即 [0, 文件大小]）。

如果写入偏移量 OFFSET 超出文件逻辑大小：

​ext4/XFS：可能直接丢弃越界写入的数据（不会分配磁盘块）。

​其他文件系统：行为可能不同，但通常不会为越界数据分配空间。

​​（2）自然回写（Background Writeback）​
Linux 内核的 ​**pdflush 或 bdi 线程** 会定期将脏页（Dirty Pages）刷写到磁盘。

​但自然回写仍然受文件逻辑大小的限制：

文件系统不会为超出文件逻辑大小的数据分配物理块，因此这些数据不会被写入磁盘。

即使内存中有脏页，内核也不会处理超出文件范围的写入。

这种情况下文件内容仅仅只是被写入到了pagecache中，而不是磁盘中。

只有写入的偏移 < 文件逻辑大小 && 写入的偏移 < mmap映射实际的大小 才能让数据成功落盘。

同时为了节省磁盘空间如 ext4 文件系统，会采取稀疏文件的形式对文件进行存储。

假设文件大小为 10KB 只有 1k 处和 9k 处各有一个字节的数据，其他地方没有数据。1KB 位于 ​第 0 个块​（占用磁盘）。9KB 位于 ​第 2 个块​（占用磁盘）。第 1 个块​（4096~8191）​无数据，不占用磁盘空间。

PageCache 的映射行为

当通过 mmap 或 read 访问文件时，PageCache 会按需加载数据块：

​已写入数据的块​（如第 0 块和第 2 块）：

文件系统会从磁盘加载到 PageCache。访问这些块时，直接命中缓存。

​未写入数据的块​（如第 1 块）：

​PageCache 不会映射到磁盘区域​（因为磁盘上无对应数据）。

访问这些地址时：​

读取：返回全零（\0），​不触发磁盘 I/O。

​写入：如果文件系统支持稀疏文件（如 ext4），会动态分配磁盘块，并更新 PageCache。
如果不支持（如 FAT32），可能触发 SIGBUS。