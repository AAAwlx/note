# 内存管理的初始化

## 获取可用的物理内存区域

在不同的指令集架构中有不同的获取可用物理内存区域的做法。但无论是什么架构的内核，在初始化中都需要经历获取物理内存区域这一过程。

在x86架构下这一功能由 BIOS 中断 Ox IS 的子功能 E820 能够获取系统的内存布局。

由e820子功能获取到的物理内存区域会被存放在 e820map

```c
struct e820entry {
	__u64 addr;    /* 内存段的起始地址 */
	__u64 size;    /* 内存段的大小 */
	__u32 type;    /* 内存段的类型 */
} __attribute__((packed));


struct e820map {
	__u32 nr_map;
	struct e820entry map[E820_X_MAX];
};
```

```c
void __init paging_init(void)
{
	unsigned long max_zone_pfns[MAX_NR_ZONES];

	memset(max_zone_pfns, 0, sizeof(max_zone_pfns));
	max_zone_pfns[ZONE_DMA] = MAX_DMA_PFN;
	max_zone_pfns[ZONE_DMA32] = MAX_DMA32_PFN;
	max_zone_pfns[ZONE_NORMAL] = max_pfn;

	sparse_memory_present_with_active_regions(MAX_NUMNODES);
	sparse_init();

	/*
	 * clear the default setting with node 0
	 * note: don't use nodes_clear here, that is really clearing when
	 *	 numa support is not compiled in, and later node_set_state
	 *	 will not set it back.
	 */
	node_clear_state(0, N_NORMAL_MEMORY);

	free_area_init_nodes(max_zone_pfns);
}
```