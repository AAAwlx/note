# 内存虚拟化

## 内存虚拟化的主要手段

内存虚拟化的核心目标是让每个虚拟机（VM）拥有独立、连续的物理内存视图，同时由Hypervisor（如KVM、Xen、VMware）高效管理和分配物理内存。以下是常见的技术手段及其原理和应用：

---

**1. 分页机制（Paging）**

- **原理**：  
  Hypervisor通过维护虚拟机的页表（Page Table），将虚拟机看到的“客户物理地址”（GPA）转换为实际“主机物理地址”（HPA）。Guest OS的页表更新需要被Hypervisor截获并验证。
- **缺点**：  
  频繁的页表修改导致大量VM-Exit，性能开销大。

---

**2. 影子页表（Shadow Page Table）**

- **原理**：  
  Hypervisor为每个虚拟机维护一个“影子页表”，直接将虚拟机的虚拟地址（GVA）映射到主机物理地址（HPA）。Guest OS的页表修改会被Hypervisor同步到影子页表。
- **优点**：  
  减少VM-Exit次数，提升地址转换效率。  
- **缺点**：  
  影子页表的维护复杂，尤其在多级页表或大内存场景下开销较大。

---

**3. 硬件辅助虚拟化（EPT/NPT）**

- **原理**：  
  - **Intel EPT（Extended Page Tables）** 和 **AMD NPT（Nested Page Tables）** 是CPU提供的硬件功能，支持两层地址转换：  
    **GVA → GPA**（由Guest OS页表管理）  
    **GPA → HPA**（由EPT/NPT页表管理）。  
  - Hypervisor预先配置EPT/NPT表，硬件自动完成两级地址转换。
- **优点**：  
  - 消除影子页表的维护开销，减少VM-Exit。  
  - 性能接近原生系统。
- **应用**：  
  KVM、VMware等主流Hypervisor默认启用EPT/NPT。

---

**4. 内存气球（Memory Ballooning）**

- **原理**：  
  - Hypervisor通过虚拟机内的气球驱动（如`virtio-balloon`）动态调整分配给VM的内存。  
  - **膨胀（Inflate）**：回收VM未使用的内存页。  
  - **收缩（Deflate）**：将内存返还给VM。
- **优点**：  
  实现内存超分配（Overcommit），提高物理内存利用率。  
- **缺点**：  
  依赖Guest内驱动的协作，可能因内存回收导致性能波动。

---

**5. 内存去重（Memory Deduplication）**

- **原理**：  
  通过扫描虚拟机内存，合并内容相同的页面（如全零页或共享库代码）。  
  - **KSM（Kernel Samepage Merging）**：Linux Hypervisor（如KVM）的内核特性，定期合并重复页。
- **优点**：  
  显著减少内存占用，尤其适用于多台运行相同OS的VM。  
- **缺点**：  
  扫描和合并操作可能引入CPU开销，需权衡性能与内存节省。

---

**6. 大页（Huge Pages）**

- **原理**：  
  使用2MB或1GB的大内存页（对比传统的4KB页），减少页表项数量和TLB缺失率。
- **优点**：  
  - 提升内存访问效率，降低地址转换开销。  
  - 尤其适合数据库、高性能计算等内存密集型应用。
- **配置**：  
  VM配置大页后，Hypervisor需预留连续的物理大页内存。

---

**7. 直接设备访问与IOMMU（VT-d/AMD-Vi）**

- **原理**：  
  - **IOMMU（如Intel VT-d, AMD-Vi）**：允许设备直接访问虚拟机内存（DMA重映射），避免通过Hypervisor中转。  
  - **VFIO/SR-IOV**：结合IOMMU，实现网卡、GPU等设备的直接分配（PCI Passthrough）。
- **优点**：  
  - 消除I/O虚拟化瓶颈，接近物理设备性能。  
  - 增强安全性（隔离设备DMA访问）。
- **应用**：  
  高性能虚拟化场景（如NFV、GPU虚拟化）。

---

**8. 内存压缩（Memory Compression）**

- **原理**：  
  将未活跃使用的内存页压缩存储，减少物理内存占用。例如，VMware的透明页压缩（TPS）。
- **优点**：  
  延迟内存交换（Swap）操作，降低响应延迟。  
- **缺点**：  
  压缩/解压需要CPU开销，可能影响性能。

---

**9. 内存交换（Swap Space）**

- **原理**：  
  将VM不活跃的内存页交换到磁盘空间，释放物理内存。
- **缺点**：  
  磁盘I/O延迟高，可能导致严重性能下降，通常作为最后手段。

---

**10. 内存超分配（Memory Overcommit）**

- **原理**：  
  分配给所有VM的内存总和超过物理内存，依赖以下技术组合管理：  
  - 内存气球（回收空闲内存）  
  - 内存去重（合并重复页）  
  - 交换空间（应急回收）。
- **风险**：  
  若超分配过多且回收不足，可能触发大量交换，导致系统卡顿。

---

### **技术对比与选型建议**

| **技术**           | **典型应用场景**                     | **性能影响**       | **实现复杂度** |
|--------------------|-------------------------------------|--------------------|---------------|
| **EPT/NPT**        | 通用场景，硬件支持时必选             | 高（硬件加速）     | 低            |
| **内存气球**       | 动态调整内存，超分配环境             | 中等（依赖Guest）  | 中            |
| **KSM去重**        | 多台相似VM（如云服务器）             | 低（CPU开销）      | 中            |
| **大页**           | 内存密集型应用（如数据库）           | 高（减少TLB缺失）  | 中            |
| **IOMMU/VFIO**     | 高性能I/O设备直通                   | 接近物理设备       | 高            |

---

### **总结**

- **核心目标**：平衡性能、资源利用率和隔离性。  
- **硬件辅助（EPT/NPT）**是基础，结合**大页**和**内存去重**优化性能与密度。  
- **动态调整**依赖气球技术，**超分配**需谨慎避免交换风暴。  
- 生产环境中通常组合多种技术（如EPT + 大页 + KSM + 气球）。

## 影子页表

kvm_vcpu_arch 

https://github.com/0voice/kernel_awsome_feature/blob/main/KVM%E4%B9%8B%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96.md